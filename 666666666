Phantomâ€¯Edgeâ€¯Loader â€“ Engineering Rules & Development Log

â€œStealth isnâ€™t a feature; itâ€™s the groundâ€‘truth budget. Every byte you emit is a potential IOC.â€

1. Project NorthÂ Star

Key Aspect

Value

Objective

Diskâ€‘less, modular Windows 10/11 (23H2+) loader that sidesteps modern EDR/ATP stacks (Defender, CrowdStrike, Cortex)

Footprint

No WinAPI, Noâ€‘CRT, direct PEB/EAT lookâ€‘ups, indirect syscalls only

Languages

Câ€¯90 + MASM/Intel ASM (x64)

Toolchains

MSVCÂ 17.x, GCC/ClangÂ 15+, cmake â‰¥ 3.15

Styleâ€‘Guide

K&R braces, snake_case, minimal comments (only nonâ€‘obvious logic)

2. Immutable Rules Â (â€œbreak = revertâ€)

OPSEC firstÂ â€“ never introduce: plain strings, RWX pages longer thanÂ 500â€¯Âµs, obvious WinAPI imports, or debug artefacts.

No direct WinAPI â€“ always reach via wrapper (find_module_base, find_function) or new indirect syscall stubs.

No CRT â€“ Release builds /NODEFAULTLIB and /ENTRY:RealEntry (Â§4). Debug may keep CRT temporarily.

x64 baseline â€“ 32â€‘bit is outâ€‘ofâ€‘scope until Phaseâ€‘3.

Modular OR Die â€“ every evasion/payload lives in its own TU; wiring happens in core/loader.c.

3. Repository Layout Â (ğŸ“ topâ€‘level)
/ build/               â†’ CI artefacts (gitâ€‘ignored)
/ core/                â†’ lowâ€‘level engine (utils, syscalls, evasion, rdi, loader)
/ include/             â†’ public headers only (never include <windows.h>)
/ stub/                â†’ handâ€‘written entry shim (RealEntry)
/ test_payload/        â†’ minimal reflective DLL for integration tests
/ fuzzer/              â†’ libFuzzer harness and corpora (optional)
CMakeLists.txt         â†’ singleâ€‘root build script
project_log.md         â†’ running task ledger (this file supersedes)

NOTE â€“ All future helper scripts (Python/PS) belong in /tools/ (to be created).

4. Build Matrix & Flags

4.1 MSVC

# Release (default)
/O2 /GL           # speed & LTO
/GS- /Gw /Gy      # kill stack cookie, functionâ€‘level linking
/NODEFAULTLIB     # Noâ€‘CRT
/ENTRY:RealEntry  # custom stub
/SUBSYSTEM:WINDOWS
/LTCG /OPT:REF /OPT:ICF

âš  Perâ€‘file override: core/loader.c compiles without /GL (wholeâ€‘program opt interferes with section merging).

4.2 GCC / Clang

-O3 -fvisibility=hidden -flto -fno-stack-protector -s

. Coding Style Cheatâ€‘sheet

Braces: if (foo) { â€¦ } â€“ always same line.

Indent: 4 spaces, no tabs.

Headers: match .c name; expose only what other units need.

Enums > #defines for constants that cross files.

Comments: // inline for tiny hints, /* block */ for algo description.

6. Core Abstractions & Helper API

File

Responsibility

core/utils.c

PEB traversal, hashing, find_* resolvers

core/syscalls.c

SyscallÂ ID resolution (resolve_syscall_id) + naked wrappers

core/mem.c

Thin wrappers around NtAllocateVirtualMemory, NtProtectVirtualMemory, etc.

core/evasion.c

unhook_ntdll, AMSI/ETW patch, future sleep encryption

core/rdi.c

Reflective DLL loader

core/loader.c

Orchestration stateâ€‘machine (initÂ â†’ evasionÂ â†’ payloadÂ â†’ exit)

DoÂ _not call WinAPI from any of the above. If you need a new NT routine:

Add wrapper in include/syscalls.h & core/syscalls.c.

Pipe through core/mem.c if memoryâ€‘related.

7. Evasion & Memory Hygiene

Unhooking: Load fresh ntdll.dll from System32, copy .text over inâ€‘memory image.

Indirect Syscalls: Haloâ€™sÂ Gate/TartarusÂ Gate (TODOÂ F1) to survive ID drift on Patch Tuesday.

Sleep Encryption: XOR page encryption + NtDelayExecution inside VEHâ€‘guard (planned Taskâ€¯F4).

Timeâ€‘window targets:

Event

MaxÂ RWX exposure

Loader decrypt

<Â 200â€¯Âµs

Sleep wakeâ€‘upÂ (Ekkoâ€‘like)

<Â 50â€¯Âµs

8. Test & Fuzz Policy

libFuzzer harness (fuzzer/test_harness.c) feeds malformed PEs into execute_reflective_dll.

CrashÂ =Â bugÂ >Â EDR detection: fix first, bypass later.

Weekly CI run on latest Windows Insider VM; break on:

changed syscall IDs

changed g_ShimsEnabled offset (EarlyÂ Cascade)

9. Status SnapshotÂ (24â€‘Mayâ€‘2025)

Imported from project_log.md + verification:

âœ… PhaseÂ 1 bootstrapped (dirs, build, core utils)â€¯â€” green.

âœ… Indirect syscalls stub operational.

âœ… RDI MVP wired.

ğŸŸ¡ Noâ€‘CRT Release build links but crashes at NtTerminateProcessÂ â†’ see TaskÂ F3.

ğŸŸ¡ Placeholder payload array still dummy bytes.

10. Immediate TODO (Sprintâ€‘0A)

ID

Owner

Description

Blockers

F3

YOU

Finalise Noâ€‘CRT: fix missing intrinsics (memset, memcmp), ensure /NODEFAULTLIB links only ntoskrnl.lib equivalents.

Investigate unresolved externals in memcpy, maybe /Zl?

T1

YOU

Convert test_payload.dll â†’ C array (use xxd -i), include in core/payload.h.

None

T2

YOU

Replace GetSystemDirectoryW call with direct PEB parse.

Needs RTL_USER_PROCESS_PARAMETERS struct

F4

backlog

Sleep encryption (Ekkoâ€‘lite) â€“ encrypt .text & .rdata, decrypt on timer.

Haloâ€™sÂ Gate first

11. Backlog / Research

Haloâ€™sÂ Gate / TartarusÂ Gate integration (robust syscallÂ ID).

EarlyÂ Cascade offsets autoâ€‘resolver via minimal PDB parser.

ThreadÂ Stack Spoofing for worker threads.

AtomBombingÂ 2.0 stub (low priority until PoC stable).

12. Cursorâ€‘AI PreambleÂ (for cheaper LLMs)

You are editing PhantomÂ Edge Loader (see RULES above).
NEVER introduce CRT or WinAPI imports.
Follow K&R, snake_case, MSVC/GCC x64.
When uncertain, ask via TODO comment rather than guessing.
Return full, compilable file contents.
Explain edits in â‰¤3 lines after the code block.

Place this preamble at the top of any future Cursor chat or commit description.